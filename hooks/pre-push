#!/bin/bash
set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get the root directory of the git repository
GIT_ROOT=$(git rev-parse --show-toplevel)
cd "$GIT_ROOT"

echo "ğŸš€ Running pre-push checks..."

# Ensure we aren't running in watch mode
export CI=true

# Check for v3 TypeScript files in the repository (not just staged)
V3_TS_FILES=$(find packages services -name "*.ts" -o -name "*.tsx" 2>/dev/null || true)

if [ -n "$V3_TS_FILES" ]; then
    echo -e "\nğŸ§ª Running full test suite (989 tests)..."

    if pnpm test; then
        echo -e "${GREEN}âœ… All tests passed!${NC}"
    else
        echo -e "${RED}âŒ Tests failed! Aborting push.${NC}"
        echo -e "\n${YELLOW}To bypass this hook (not recommended): git push --no-verify${NC}"
        exit 1
    fi
fi

echo -e "\n${GREEN}âœ… All pre-push checks passed! Pushing to remote...${NC}"
