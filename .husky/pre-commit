#!/bin/sh

# Clean up stale git lock files
# These can be left behind when pre-commit hooks are interrupted (Ctrl+C, IDE crashes, etc.)
LOCK_FILE=".git/index.lock"
if [ -f "$LOCK_FILE" ]; then
    # Check if lock is older than 5 minutes (300 seconds)
    if [ "$(find "$LOCK_FILE" -mmin +5 2>/dev/null)" ]; then
        echo "⚠️  Removing stale git lock file (older than 5 minutes)"
        rm -f "$LOCK_FILE"
    fi
fi

# Run lint-staged (prettier, eslint, secretlint on staged files only)
npx lint-staged

# Auto-regenerate pglite schema when Prisma schema changes
# This prevents integration test schema drift
STAGED_PRISMA_SCHEMA=$(git diff --cached --name-only | grep -E '^prisma/schema\.prisma$' || true)

if [ -n "$STAGED_PRISMA_SCHEMA" ]; then
    echo "Prisma schema changed - regenerating pglite integration test schema..."

    # Use dummy URL - prisma migrate diff doesn't connect to the database.
    # It just needs the provider hint (postgresql://) to generate correct SQL.
    # This matches what CI does in .github/workflows/ci.yml
    if [ -z "$DATABASE_URL" ]; then
        export DATABASE_URL="postgresql://dummy:dummy@localhost:5432/dummy"
    fi

    # Regenerate the schema
    npx prisma migrate diff \
        --from-empty \
        --to-schema ./prisma/schema.prisma \
        --script 2>/dev/null > packages/test-utils/schema/pglite-schema.sql

    # Stage the regenerated file
    git add packages/test-utils/schema/pglite-schema.sql
    echo "✓ pglite-schema.sql regenerated and staged"
fi

# Check for dangerous Prisma migrations
STAGED_MIGRATION_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^prisma/migrations/.*\.sql$' || true)

if [ -n "$STAGED_MIGRATION_FILES" ]; then
    echo "Checking Prisma migrations for dangerous operations..."
    for file in $STAGED_MIGRATION_FILES; do
        # Only flag if DROP INDEX exists WITHOUT a corresponding CREATE INDEX
        if grep -q 'DROP INDEX.*idx_memories_embedding' "$file" && ! grep -q 'CREATE INDEX.*idx_memories_embedding' "$file"; then
            echo "DANGER: Migration drops vector index WITHOUT recreating it!"
            echo "   File: $file"
            echo "   The idx_memories_embedding index is essential for pgvector performance."
            echo "   Either remove the DROP INDEX or add a CREATE INDEX statement."
            exit 1
        fi
    done
    echo "Migrations safe"
fi
