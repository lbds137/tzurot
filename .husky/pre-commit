#!/bin/sh

# Run lint-staged (prettier, eslint, secretlint on staged files only)
npx lint-staged

# Check for dangerous Prisma migrations
STAGED_MIGRATION_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^prisma/migrations/.*\.sql$' || true)

if [ -n "$STAGED_MIGRATION_FILES" ]; then
    echo "Checking Prisma migrations for dangerous operations..."
    for file in $STAGED_MIGRATION_FILES; do
        # Only flag if DROP INDEX exists WITHOUT a corresponding CREATE INDEX
        if grep -q 'DROP INDEX.*idx_memories_embedding' "$file" && ! grep -q 'CREATE INDEX.*idx_memories_embedding' "$file"; then
            echo "DANGER: Migration drops vector index WITHOUT recreating it!"
            echo "   File: $file"
            echo "   The idx_memories_embedding index is essential for pgvector performance."
            echo "   Either remove the DROP INDEX or add a CREATE INDEX statement."
            exit 1
        fi
    done
    echo "Migrations safe"
fi
