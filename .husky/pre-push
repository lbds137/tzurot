#!/bin/sh

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "Running pre-push checks..."

# 1. Validate branch name (skip for main/develop/scratch)
BRANCH=$(git rev-parse --abbrev-ref HEAD)
if [ "$BRANCH" != "develop" ] && [ "$BRANCH" != "main" ]; then
    # Allow scratch/ prefix for WIP branches (skip all checks)
    if echo "$BRANCH" | grep -q "^scratch/"; then
        echo "${YELLOW}Scratch branch detected - skipping all checks${NC}"
        exit 0
    fi

    # Validate branch naming convention
    if ! echo "$BRANCH" | grep -qE "^(feat|fix|chore|refactor|docs|test|ci)/"; then
        echo "${RED}Branch name must follow pattern: type/description${NC}"
        echo "   Valid types: feat, fix, chore, refactor, docs, test, ci"
        echo "   Example: feat/add-user-auth"
        echo "   Use scratch/ prefix for WIP branches that skip checks"
        exit 1
    fi
fi

# 2. Determine what files are being pushed
UPSTREAM=$(git rev-parse --abbrev-ref --symbolic-full-name @{u} 2>/dev/null || echo "")

if [ -n "$UPSTREAM" ]; then
    CHANGED_FILES=$(git diff --name-only "$UPSTREAM" HEAD 2>/dev/null || true)
else
    BASE_BRANCH=$(git rev-parse --verify origin/develop 2>/dev/null || git rev-parse --verify origin/main 2>/dev/null || echo "")
    if [ -n "$BASE_BRANCH" ]; then
        MERGE_BASE=$(git merge-base HEAD "$BASE_BRANCH" 2>/dev/null || echo "$BASE_BRANCH")
        CHANGED_FILES=$(git diff --name-only "$MERGE_BASE" HEAD 2>/dev/null || true)
    else
        CHANGED_FILES=""
    fi
fi

# 3. Check if only docs/config changed
# Include package.json and pnpm-lock.yaml as they can affect builds (dependencies, scripts)
CODE_FILES=$(echo "$CHANGED_FILES" | grep -E '\.(ts|tsx|js|jsx|mjs|cjs|d\.ts)$|package\.json$|pnpm-lock\.yaml$' || true)

if [ -z "$CHANGED_FILES" ]; then
    echo "${YELLOW}No files detected in push - skipping checks${NC}"
    exit 0
elif [ -z "$CODE_FILES" ]; then
    echo "${GREEN}Only documentation/config files changed - skipping build and tests${NC}"
    exit 0
fi

# 4. Detect resource-constrained environment
# Use LOW_RESOURCE_MODE=1 env var to enable throttling (e.g., for Steam Deck)
# Can be set in .env or shell profile
TURBO_ARGS="--output-logs=errors-only"

# Source LOW_RESOURCE_MODE from .env if not already set
if [ -z "$LOW_RESOURCE_MODE" ] && [ -f ".env" ]; then
    LOW_RESOURCE_MODE=$(grep -E '^LOW_RESOURCE_MODE=' .env | cut -d '=' -f2-)
fi

if [ -n "$LOW_RESOURCE_MODE" ]; then
    echo "${YELLOW}Low-resource mode enabled - throttling builds${NC}"
    # Limit to 1 concurrent task to prevent memory explosion
    TURBO_ARGS="$TURBO_ARGS --concurrency=1"
    # Cap Node.js memory to 2GB per process
    export NODE_OPTIONS="--max-old-space-size=2048"
fi

# 5. Determine filter scope for Turbo
# Use origin/develop as base (or origin/main as fallback)
if git rev-parse --verify origin/develop >/dev/null 2>&1; then
    FILTER_BASE="origin/develop"
elif git rev-parse --verify origin/main >/dev/null 2>&1; then
    FILTER_BASE="origin/main"
else
    FILTER_BASE=""
fi

if [ -n "$FILTER_BASE" ]; then
    # Filter to only packages changed since base branch (plus their dependents)
    TURBO_FILTER="--filter=...[$FILTER_BASE]"
    echo "Code changes detected. Running Turbo on affected packages..."
else
    # No base branch found, run on all packages
    TURBO_FILTER=""
    echo "Code changes detected. Running Turbo on all packages..."
fi

# 6. Run Turbo for cached builds and tests
# Ensure CI mode (no watch mode, no prompts)
export CI=true

# shellcheck disable=SC2086 - Intentional word splitting for Turbo args
# TURBO_FILTER and TURBO_ARGS are space-separated flags, never contain spaces in values
if ! pnpm turbo run build lint test $TURBO_FILTER $TURBO_ARGS; then
    echo "${RED}Pre-push checks failed!${NC}"
    echo "Fix the issues before pushing, or use: git push --no-verify"
    exit 1
fi

# 7. Run test file type checking (warning only until baseline is fixed)
echo "Running test file type checking..."
# shellcheck disable=SC2086
if ! pnpm turbo run typecheck:spec $TURBO_FILTER $TURBO_ARGS 2>/dev/null; then
    echo "${YELLOW}Test file type checking found errors${NC}"
    echo "Run 'pnpm typecheck:spec' to see details"
fi

# 8. Run copy-paste detection (warning only - doesn't block push)
echo "Running copy-paste detection..."
if ! pnpm cpd --exitCode 0 2>/dev/null; then
    echo "${YELLOW}Copy-paste detection found potential duplicates${NC}"
    echo "Run 'pnpm cpd:report' to see detailed HTML report"
fi

echo "${GREEN}All pre-push checks passed!${NC}"
