#!/bin/sh

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "Running pre-push checks..."

# 1. Validate branch name (skip for main/develop/scratch)
BRANCH=$(git rev-parse --abbrev-ref HEAD)
if [ "$BRANCH" != "develop" ] && [ "$BRANCH" != "main" ]; then
    # Allow scratch/ prefix for WIP branches (skip all checks)
    if echo "$BRANCH" | grep -q "^scratch/"; then
        echo "${YELLOW}Scratch branch detected - skipping all checks${NC}"
        exit 0
    fi

    # Validate branch naming convention
    if ! echo "$BRANCH" | grep -qE "^(feat|fix|chore|refactor|docs|test|ci)/"; then
        echo "${RED}Branch name must follow pattern: type/description${NC}"
        echo "   Valid types: feat, fix, chore, refactor, docs, test, ci"
        echo "   Example: feat/add-user-auth"
        echo "   Use scratch/ prefix for WIP branches that skip checks"
        exit 1
    fi
fi

# 2. Determine what files are being pushed
UPSTREAM=$(git rev-parse --abbrev-ref --symbolic-full-name @{u} 2>/dev/null || echo "")

if [ -n "$UPSTREAM" ]; then
    CHANGED_FILES=$(git diff --name-only "$UPSTREAM" HEAD 2>/dev/null || true)
else
    BASE_BRANCH=$(git rev-parse --verify origin/develop 2>/dev/null || git rev-parse --verify origin/main 2>/dev/null || echo "")
    if [ -n "$BASE_BRANCH" ]; then
        MERGE_BASE=$(git merge-base HEAD "$BASE_BRANCH" 2>/dev/null || echo "$BASE_BRANCH")
        CHANGED_FILES=$(git diff --name-only "$MERGE_BASE" HEAD 2>/dev/null || true)
    else
        CHANGED_FILES=""
    fi
fi

# 3. Check if only docs/config changed
# Include package.json and pnpm-lock.yaml as they can affect builds (dependencies, scripts)
CODE_FILES=$(echo "$CHANGED_FILES" | grep -E '\.(ts|tsx|js|jsx|mjs|cjs|d\.ts)$|package\.json$|pnpm-lock\.yaml$' || true)

if [ -z "$CHANGED_FILES" ]; then
    echo "${YELLOW}No files detected in push - skipping checks${NC}"
    exit 0
elif [ -z "$CODE_FILES" ]; then
    echo "${GREEN}Only documentation/config files changed - skipping build and tests${NC}"
    exit 0
fi

# 4. Detect resource-constrained environment (Steam Deck, etc.)
# Check hostname or explicit env var for low-resource mode
TURBO_ARGS="--output-logs=errors-only"
HOSTNAME=$(hostname 2>/dev/null || echo "")

if echo "$HOSTNAME" | grep -qi "deck" || [ -n "$LOW_RESOURCE_MODE" ]; then
    echo "${YELLOW}Low-resource mode detected - throttling for Steam Deck${NC}"
    # Limit to 1 concurrent task to prevent memory explosion
    TURBO_ARGS="$TURBO_ARGS --concurrency=1"
    # Cap Node.js memory to 2GB per process
    export NODE_OPTIONS="--max-old-space-size=2048"
fi

# 5. Determine filter scope for Turbo
# Use origin/develop as base (or origin/main as fallback)
FILTER_BASE=$(git rev-parse --verify origin/develop 2>/dev/null && echo "origin/develop" || \
              git rev-parse --verify origin/main 2>/dev/null && echo "origin/main" || echo "")

if [ -n "$FILTER_BASE" ]; then
    # Filter to only packages changed since base branch (plus their dependents)
    TURBO_FILTER="--filter=...[$FILTER_BASE]"
    echo "Code changes detected. Running Turbo on affected packages..."
else
    # No base branch found, run on all packages
    TURBO_FILTER=""
    echo "Code changes detected. Running Turbo on all packages..."
fi

# 6. Run Turbo for cached builds and tests
# Ensure CI mode (no watch mode, no prompts)
export CI=true

# shellcheck disable=SC2086
if ! pnpm turbo run build lint test $TURBO_FILTER $TURBO_ARGS; then
    echo "${RED}Pre-push checks failed!${NC}"
    echo "Fix the issues before pushing, or use: git push --no-verify"
    exit 1
fi

echo "${GREEN}All pre-push checks passed!${NC}"
